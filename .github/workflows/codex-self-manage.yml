name: codex-self-manage

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  ci:
    if: github.event_name == 'workflow_dispatch' || contains(join(fromJson(toJson(github.event.pull_request.labels)).*.name, ' '), 'codex-ci')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
      - name: Install project and tools
        run: |
          python -m pip install -U pip
          pip install -e .
          pip install pre-commit pytest coverage pip-audit
      - name: Pre-commit
        run: pre-commit run --all-files
      - name: Tests
        run: |
          coverage run -m pytest -q
          coverage xml
      - name: Dependency audit
        run: |
          pip-audit -r requirements.txt || true
          pip-audit || true
      - name: Codex CLI audit
        run: |
          python tools/codex_cli.py audit || true
